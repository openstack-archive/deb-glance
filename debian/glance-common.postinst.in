#!/bin/sh

set -e

ETC=/etc/glance
API_CONF=${ETC}/glance-api.conf
GREG_CONF=${ETC}/glance-registry.conf

#PKGOS-INCLUDE#

write_auth_token_and_auth () {
	db_get glance/paste-flavor || true
	FLAVOR="$RET"
	pkgos_inifile set ${API_CONF} paste_deploy flavor ${FLAVOR}
	pkgos_inifile set ${GREG_CONF} paste_deploy flavor ${FLAVOR}

	case "$FLAVOR" in
	keystone*)
		pkgos_write_admin_creds ${API_CONF} keystone_authtoken glance
		pkgos_write_admin_creds ${GREG_CONF} keystone_authtoken glance
	;;
	esac
}

if [ "$1" = "configure" ] || [ "$1" = "reconfigure" ] ; then
	. /usr/share/debconf/confmodule
	. /usr/share/dbconfig-common/dpkg/postinst

	pkgos_var_user_group glance

	# Make sure we have a /etc/glance folder with config files in it.
	pkgos_write_new_conf glance glance-api.conf
	pkgos_write_new_conf glance glance-registry.conf
	pkgos_write_new_conf glance glance-api-paste.ini
	pkgos_write_new_conf glance glance-registry-paste.ini
	pkgos_write_new_conf glance glance-cache.conf
	pkgos_write_new_conf glance glance-scrubber.conf
	pkgos_write_new_conf glance policy.json
	pkgos_write_new_conf glance schema-image.json

	# Copy metadefs files from /usr/share/glance-common/metadefs to /etc/glance/metadefs
	mkdir -p /etc/glance/metadefs
	chown glance:glance /etc/glance/metadefs
	for i in `ls /usr/share/glance-common/metadefs/*.json` ; do
		MDFILE=`basename $i`
		if ! [ -e /etc/glance/metadefs/$MDFILE ] ; then
			install -D -m 0640 -o glance -g glance /usr/share/glance-common/metadefs/$MDFILE /etc/glance/metadefs/$MDFILE
		fi
	done

	# Do the db creation using dbconfig-common
	db_get glance/configure_db
	if [ "$RET" = "true" ] ; then
		pkgos_dbc_postinst ${API_CONF} database connection glance $@
	fi

	# Convert tables into utf8 if we're upgrading from prior to Icehouse.
	db_get glance/configure_db
	if [ "$RET" = "true" ] && [ -n "${2}" ] \
	  && dpkg --compare-versions 2014.1~ gt "${2}" \
	  && [ -r /usr/share/dbconfig-common/dpkg/postinst ] \
	  && [ "${dbc_type}" = "mysql" ] ; then
		Q="SET FOREIGN_KEY_CHECKS=0;
ALTER IGNORE TABLE migrate_version  CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
ALTER IGNORE TABLE image_locations  CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
ALTER IGNORE TABLE image_members    CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
ALTER IGNORE TABLE image_properties CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
ALTER IGNORE TABLE image_tags       CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
ALTER IGNORE TABLE images           CONVERT TO CHARACTER SET utf8 COLLATE utf8_unicode_ci;
SET FOREIGN_KEY_CHECKS=1;"
		pkgos_mysql_query ${dbc_dbuser} ${dbc_dbpass} ${dbc_dbserver:-localhost} "${dbport}" ${dbc_dbname} "${Q}"
	fi
	db_get glance/configure_db
	if [ "$RET" = "true" ] ; then
		pkgos_inifile get ${API_CONF} database connection
		pkgos_inifile set ${GREG_CONF} database connection "${RET}"
	fi

	pkgos_rabbit_write_conf ${API_CONF} DEFAULT glance

        # Upgrade or create the db if directed to do so
	db_get glance/configure_db
	if [ "$RET" = "true" ] ; then
		echo "Now doing glance-manage db_sync: this may take a while..."
		su glance -c "glance-manage db_sync" || true
	fi

	write_auth_token_and_auth
	db_stop

	chown -R glance:adm /var/log/glance/
	chmod 0750 /var/log/glance/
	chown glance:glance -R /var/lib/glance/ /etc/glance/
fi

#DEBHELPER#

exit 0
